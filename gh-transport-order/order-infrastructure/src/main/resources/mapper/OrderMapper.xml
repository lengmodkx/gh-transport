<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ghtransport.order.infrastructure.persistence.mapper.OrderMapper">

    <resultMap id="BaseResultMap" type="com.ghtransport.order.infrastructure.persistence.po.OrderPO">
        <id column="id" property="id"/>
        <result column="order_no" property="orderNo"/>
        <result column="customer_id" property="customerId"/>
        <result column="shipping_address" property="shippingAddress"/>
        <result column="status" property="status"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="remark" property="remark"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <resultMap id="ItemResultMap" type="com.ghtransport.order.infrastructure.persistence.po.OrderItemPO">
        <id column="item_id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="product_name" property="productName"/>
        <result column="specification" property="specification"/>
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
        <result column="subtotal" property="subtotal"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, order_no, customer_id, shipping_address, status, total_amount, remark, created_at, updated_at
    </sql>

    <sql id="Item_Column_List">
        id as item_id, order_id, product_id, product_name, specification, price, quantity, subtotal
    </sql>

    <insert id="insert" useGeneratedKeys="false">
        INSERT INTO `order` (
            id, order_no, customer_id, shipping_address, status, total_amount, remark, created_at, updated_at
        ) VALUES (
            #{po.id}, #{po.orderNo}, #{po.customerId}, #{po.shippingAddress}, #{po.status},
            #{po.totalAmount}, #{po.remark}, #{po.createdAt}, #{po.updatedAt}
        )
    </insert>

    <insert id="insertItems">
        INSERT INTO order_item (id, order_id, product_id, product_name, specification, price, quantity, subtotal)
        VALUES
        <foreach collection="items" item="item" separator=",">
            (#{item.id}, #{item.orderId}, #{item.productId}, #{item.productName},
             #{item.specification}, #{item.price}, #{item.quantity}, #{item.subtotal})
        </foreach>
    </insert>

    <update id="update">
        UPDATE `order`
        <set>
            <if test="po.status != null">status = #{po.status},</if>
            <if test="po.totalAmount != null">total_amount = #{po.totalAmount},</if>
            <if test="po.remark != null">remark = #{po.remark},</if>
            <if test="po.updatedAt != null">updated_at = #{po.updatedAt}</if>
        </set>
        WHERE id = #{po.id}
    </update>

    <delete id="delete">
        DELETE FROM `order` WHERE id = #{id}
    </delete>

    <delete id="deleteItems">
        DELETE FROM order_item WHERE order_id = #{orderId}
    </delete>

    <select id="findById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE id = #{id}
    </select>

    <select id="findByOrderNo" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE order_no = #{orderNo}
        LIMIT 1
    </select>

    <select id="findByCustomerId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE customer_id = #{customerId}
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{pageSize} * (#{pageNum} - 1)
    </select>

    <select id="findByStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE status = #{status}
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{pageSize} * (#{pageNum} - 1)
    </select>

    <select id="findItemsByOrderId" resultMap="ItemResultMap">
        SELECT <include refid="Item_Column_List"/>
        FROM order_item
        WHERE order_id = #{orderId}
    </select>

    <select id="countByCustomerId" resultType="int">
        SELECT COUNT(1) FROM `order` WHERE customer_id = #{customerId}
    </select>

    <select id="countByStatus" resultType="int">
        SELECT COUNT(1) FROM `order` WHERE status = #{status}
    </select>

</mapper>
